name: Release # 發佈流程

on:
  push:
    tags:
      - 'v*' # 當推送以 v 開頭的標籤時觸發（例如 v1.0.0）

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 需要寫入權限來提交變更並建立 Release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 取得完整歷史紀錄以利版本標記

      - name: Update versions and commit
        run: |
          # 提取版本號 (例如 v1.0.0 -> 1.0.0)
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          FULL_TAG=${GITHUB_REF#refs/tags/}
          
          # 更新 gemini-extension.json 的 version
          jq ".version = \"$TAG_VERSION\"" gemini-extension.json > temp.json && mv temp.json gemini-extension.json
          
          # 更新 .gemini-extension-install.json 的 releaseTag
          jq ".releaseTag = \"$FULL_TAG\"" .gemini-extension-install.json > temp.json && mv temp.json .gemini-extension-install.json
          
          # 設定 Git 並提交變更回 main 分支
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add gemini-extension.json .gemini-extension-install.json
          git commit -m "chore(release): 自動同步版本號至 $FULL_TAG [skip ci]" || echo "No changes to commit"
          git push origin HEAD:main

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build
        run: bun run build

      - name: Package Extension
        run: |
          # 將必要檔案打包成 ZIP 壓縮檔
          zip -r neo-mcp.zip dist gemini-extension.json package.json GEMINI.md README.md commands

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            neo-mcp.zip
          generate_release_notes: true # 自動產生 Release Notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
